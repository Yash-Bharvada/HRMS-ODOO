generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Role {
  ADMIN
  EMPLOYEE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
}

enum LeaveType {
  PAID
  SICK
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  OVERRIDE
  APPROVE
  REJECT
}

//////////////////////
// USER
//////////////////////

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  role          Role      @default(EMPLOYEE)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  employee      Employee?
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]

  @@index([email])
}

//////////////////////
// EMPLOYEE
//////////////////////

model Employee {
  id                String    @id @default(cuid())
  userId            String    @unique
  firstName         String
  lastName          String
  phone             String?
  address           String?
  profilePictureUrl String?
  dateOfBirth       DateTime?
  joiningDate       DateTime  @default(now())
  department        String?
  designation       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendanceRecords Attendance[]
  leaveRequests     Leave[]
  payrollRecords    Payroll[]
  approvals         LeaveApproval[]

  @@index([userId])
  @@index([department])
}

//////////////////////
// REFRESH TOKEN
//////////////////////

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

//////////////////////
// ATTENDANCE
//////////////////////

model Attendance {
  id             String             @id @default(cuid())
  employeeId     String
  date           DateTime           @db.Date
  checkInTime    DateTime?
  checkOutTime   DateTime?
  status         AttendanceStatus   @default(ABSENT)
  overriddenBy   String?
  overrideReason String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  employee       Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
}

//////////////////////
// LEAVE
//////////////////////

model Leave {
  id         String       @id @default(cuid())
  employeeId String
  leaveType  LeaveType
  startDate  DateTime     @db.Date
  endDate    DateTime     @db.Date
  reason     String?
  status     LeaveStatus  @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  employee   Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvals  LeaveApproval[]

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
}

//////////////////////
// LEAVE APPROVAL
//////////////////////

model LeaveApproval {
  id           String    @id @default(cuid())
  leaveId      String
  approvedBy   String
  approvalDate DateTime  @default(now())
  comments     String?
  createdAt    DateTime  @default(now())

  leave        Leave     @relation(fields: [leaveId], references: [id], onDelete: Cascade)
  approver     Employee  @relation(fields: [approvedBy], references: [id], onDelete: Restrict)

  @@unique([leaveId, approvedBy])
  @@index([leaveId])
  @@index([approvedBy])
}

//////////////////////
// PAYROLL
//////////////////////

model Payroll {
  id            String   @id @default(cuid())
  employeeId    String
  month         DateTime @db.Date
  baseSalary    Decimal  @db.Decimal(12, 2)
  allowances    Decimal  @db.Decimal(12, 2) @default(0)
  deductions    Decimal  @db.Decimal(12, 2) @default(0)
  netSalary     Decimal  @db.Decimal(12, 2)
  effectiveDate DateTime @db.Date
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, month])
  @@index([employeeId])
  @@index([month])
}

//////////////////////
// AUDIT LOG
//////////////////////

model AuditLog {
  id         String       @id @default(cuid())
  action     AuditAction
  userId     String
  entityType String
  entityId   String
  changes    String?
  reason     String?
  createdAt  DateTime     @default(now())

  user       User         @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}
